# Hardened configuration for psyche.ffzg.hr
# Based on nginx-wordpress-harden.conf.2

server {
    listen 80;
    server_name psyche.ffzg.unizg.hr;
    return 301 https://psyche.ffzg.unizg.hr$request_uri;

    access_log /var/log/nginx/psyche-ffzg-hr-access.log;
    error_log /var/log/nginx/psyche-ffzg-hr-error.log;
}

server {
    listen 443 ssl http2;
    server_name psyche.ffzg.unizg.hr;

    root /srv/www/psyche.ffzg.hr;

    # SSL configuration
    include /etc/nginx/confs/ssl.conf;

    access_log /var/log/nginx/psyche-ffzg-hr-access.log;
    error_log /var/log/nginx/psyche-ffzg-hr-error.log;

    # Main router for WordPress pretty URLs
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ====================================================================
    # SECURITY: Deny access to sensitive files and directories
    # ====================================================================
    location = /wp-config.php { deny all; }
    location ~ /\.ht { deny all; }
    location ~* /wp-content/uploads/.*\.php$ { deny all; }
    location = /xmlrpc.php { deny all; }
    location ~* \.(engine|inc|info|install|make|module|profile|test|po|sh|sql|theme|tpl(\..+)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$|\~$ {
        deny all;
    }
    location ~* ^/wp-content/uploads/.*\.php$ {
        deny all;
    }

    # ====================================================================
    # PHP ALLOWLIST: Explicitly allow only necessary WordPress PHP files
    # ====================================================================

    # --- Root Files ---
    location = /index.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-login.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-cron.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-signup.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-activate.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }

    # --- wp-admin Files ---
    location = /wp-admin/admin-ajax.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-admin/admin-post.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    # Added for duplicate-post, redux-framework, academix-core plugins
    location = /wp-admin/options-general.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    # Added for fluentform (Action Scheduler) plugin
    location = /wp-admin/tools.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }
    location = /wp-admin/admin.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }


    # --- wp-includes Files (Rarely Needed) ---
    location = /wp-includes/js/tinymce/wp-tinymce.php { include uwsgi_params; uwsgi_modifier1 14; uwsgi_pass unix:/run/uwsgi/psyche.ffzg.hr.socket; }

    # ====================================================================
    # FINAL CATCH-ALL: Deny any other PHP file request.
    # ====================================================================
    location ~ \.php$ {
        deny all;
    }

    # Standard location block for static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires max;
        log_not_found off;
    }
}
