server {
    listen 80;
    server_name example.com;
    root /var/www/wordpress;

    index index.php;

    # Deny critical files outright
    location ~* wp-config.php {
        deny all;
    }
    location ~ /\.ht {
        deny all;
    }

    # Deny PHP execution in uploads directory
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    # Whitelist specific PHP files in wp-admin
    location ~ ^/wp-admin/(index\.php|admin-ajax\.php|admin-post\.php|async-upload\.php|media-upload\.php|admin\.php|network\.php|users\.php|update\.php|customize\.php|plugin-install\.php|themes\.php|theme-install\.php|widgets\.php|options\.php|upload\.php|site-health\.php)$ {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/uwsgi-emperor.sock;
    }
    location ~ ^/wp-admin/.*\.php$ {
        deny all;
    }

    # Whitelist root PHP entry points
    location ~ ^/(index\.php|wp-login\.php|wp-cron\.php|xmlrpc\.php|wp-signup\.php|wp-activate\.php|wp-mail\.php|wp-trackback\.php)$ {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/uwsgi-emperor.sock;
    }
    location ~ ^/.*\.php$ {
        deny all;
    }

    # Allow specific wp-includes PHP files if necessary
    location ~ ^/wp-includes/js/tinymce/wp-tinymce\.php$ {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/uwsgi-emperor.sock;
    }
    location ~ ^/wp-includes/.*\.php$ {
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    autoindex off;
}

